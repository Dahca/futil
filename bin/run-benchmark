#!/bin/bash

set -euf

cleanup() {
    if [ $? -ne 0 ]; then
        cat "$tmp/log"
    fi

    # cleanup tmp dirs
    rm -r $tmp $meminit
}
trap cleanup EXIT

# Name of the benchmark.
benchmark="$1"
# Location of the data.
data="$2"

meminit="$(mktemp -d)"
# Create .meminit files from the input JSON file.
./bin/json_to_dat.py --mode json --output "$meminit" "$data"

# Run the benchmark
tmp="$(mktemp -d)"
./target/debug/futil "$benchmark" -b verilog --verilator \
    | DATA="$meminit" ./bin/gen-vcd - 2> "$tmp/log" > "$tmp/out.vcd"

# Translate the outputs back to a JSON filetmp
./bin/json_to_dat.py --mode dat --output "$tmp/out.json" --read_ext out "$meminit"

echo -n "$(basename -s .futil $benchmark),"
cat "$tmp/log" | grep cycles | awk '{print $2}'
jq -S . "$tmp/out.json"
